## FretDance

自动完成吉它曲谱的指法编排，使得左手的移动轨迹最小化。

### 运行方法

- 安装虚拟环境，运行 `python -m venv .venv`
- 激活虚拟环境，运行 `source .venv/bin/activate`。如果是 windows 则为 `.\.venv\Scripts\activate`
- 安装依赖，运行 `pip install -r requirements.txt`
- 打开`FretDancer.ipynb`，设置内核为`.venv`
- 可以将`midiFilePath`设置为你自己的 midi 文件路径，然后运行即可
- 在最后的`output`方法中，设置参数为`True`，可以输出未按弦手指的位置。如果不设置，则默认为不显示未按弦手指的位置。
- notebook 中的代码运行结束后，应该会在 output 文件夹中得到一个后缀带`_animation`的 json 文件，
- 打开`.src\blender`中的`Kamisato_guitar.blender`文件，将`blender.py`里的代码复制到 blender 的 script 窗口中，修改 json 文件的路径值，然后运行脚本，即可生成动画。

### 简单运行原理

1. 先从 midi 文件中把所有音符读取出来，把同时发声的音符视为 chord，并且记录该 chord 的 time.
2. 把每个 chord 转化成在吉它上的可能位置.
3. 考虑每个音符要用哪个手指来按，生成所有可能的按法手型.
4. 计算从当前手型转换到新手型的代价.
5. 每迭代一个手型，就生成一个记录器，用于记录所有之前的手型，以及到达当前手型的代价.比如一开始使用的是手型 a,到下一个 chord 时，可能有 b1,b2,b3 三种手型，那么就会生成三个记录器，分别记录 a->b1,a->b2,a->b3 的代价.如果继续往下一步，可能 b1->c1,b1->c2,b1->c3,那么就会生成 9 个记录器，分别记录 a->b1->c1,a->b1->c2,a->b1->c3,a->b2->c1,a->b2->c2,a->b2->c3,a->b3->c1,a->b3->c2,a->b3->c3 的代价.
6. 显然你会发现记录器膨胀的速度是指数级的，所以我们需要剪枝。剪枝的方法是，每一代我们都设置一个记录器数量的上限，只保留一定数量的代价值最小的记录器，其他的记录器都会被丢弃.在项目里，我们使用 HandPoseRecordPool 来控制记录器的数量.
7. 最后，我们只需要找到一个代价值最小的记录器，然后由它输出所记录的手型序列，就是我们要找的最优解.

### 生成动画

既然我们已经有了每个 time 的所有手指信息，那么就可以通过一系列的计算，把这些信息转化成 blender 文件中控制手和手臂的关键帧信息，从而生成动画.

动画生成的原理基本如下：

1. 在 blender 文件上，读取吉它面板上的四个极端位置的手型信息。这四个极端位置分别是 1 把位 1 弦，1 把位 6 弦，12 把位 1 弦，12 把位 6 弦。
2. 而在上面的四个极端位置上，都存在三个可能的手掌角度，分别对应食指与中指不按同一品时的 NORMAL 状态，食指与中指按同一品时且食指向内的 INNER 状态，食指与中指按同一品且食指向外的 OUTER 状态。
3. 通过判断每一个 time 的手型信息，然后通过在以上这些极端位置和对应手型的数据中进行插值，就可以得到每个关键帧上的一系列控制器的信息，从而生成动画。

在 blender 文件夹中，有一些在 blender 运行的脚本，就是为了实现以上目的服务的。

### 其它

本项目的目的并不是为了输出给人类看的 tab,因为传统的 tab 只记录了需要按下的左手手指的运动，但对于未按弦的左手手指，缺乏对它们位置的记录。
当然，对于人类来讲，这无伤大雅，因为人类会自然的把不使用的手指移动到他觉得合适的地方。
但如果考虑到动画生成时，需要每个关键帧上的每个手指的位置信息，那么传统的 tab 就不够用了。
所以本项目的目标是输出一个包含每个 beat 的所有手指信息的序列，这样就可以为可能的动画生成提供足够的信息。
