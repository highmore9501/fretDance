## FretDance

![blender screen capture](asset\img\image00.png)
将原始的 midi 文件，转化成吉它曲谱的指法编排，使得双手的移动轨迹最小化。并且最终在 blender 中呈现演奏动画。

BiliBili 成品视频：[https://www.bilibili.com/video/BV1my411Y72J/](https://www.bilibili.com/video/BV1my411Y72J/)
![blender screen capture](asset\img\20240517043502.png)
![blender screen capture](asset\img\20240517043331.png)

### 运行方法

- 安装虚拟环境，运行 `python -m venv .venv`
- 激活虚拟环境，运行 `source .venv/bin/activate`。如果是 windows 则为 `.\.venv\Scripts\activate`
- 安装依赖，运行 `pip install -r requirements.txt`
- 运行 `python main.py`，然后在界面中选择 avatar 和 midi 文件，设置好 `FPS`，以及各弦的音高，点击提交即可生成动画所需要的 json 数据。
- 打开对应 avatar 所在的 blender 文件，去到`script`界面，选择`animate`文件，然后将上一步生成的两个 json 文件的绝对路径复制到对应的变量中，点击运行即可生成动画。
  ![blender script interface](asset\img\20240517044031.png)

### 简单运行原理

1. 先从 midi 文件中把所有音符读取出来，把同时发声的音符视为 chord，并且记录该 chord 的 time.
2. 把每个 chord 转化成在吉它上的可能位置.
3. 考虑每个音符要用哪个手指来按，生成所有可能的按法手型.
4. 计算从当前手型转换到新手型的代价.
5. 每迭代一个手型，就生成一个记录器，用于记录所有之前的手型，以及到达当前手型的代价.比如一开始时只有 1 个手型，用它按下一个音可能存在 6 种新的手型，那么就会生成 6 个记录器，每个记录器记录了从原手型到新手型的代价.然后再按下一个音时，再对这 6 个新手型进行迭代，生成新的记录器，以此类推.
6. 显然你会发现记录器膨胀的速度是指数级的，所以我们需要剪枝。剪枝的方法是，每一代我们都设置一个记录器数量的上限，只保留一定数量的代价值最小的记录器，其他的记录器都会被丢弃.在项目里，我们使用 HandPoseRecordPool 的 size 属性来控制记录器的数量.
7. 最后，我们只需要找到一个代价值最小的记录器，然后由它输出所记录的手型序列，就是我们要找的最优解.
8. 有了左手最优解后，我们就可以在此基础上来计算右手的最优解。根据每次弹奏时要演奏的弦，计算右手手型的位置，以及用哪个手指去弹更科学。计算原理和之前计算左手手型类似，也是不停的迭代，然后控制后代总数，最后找到最优解。

### 生成动画

既然我们已经有了每个 time 的所有手指信息，那么就可以通过一系列的计算，把这些信息转化成 blender 文件中控制手和手臂的关键帧信息，从而生成动画.

动画生成的原理基本如下：

1. 在 blender 文件上，读取吉它面板上的四个极端位置的手型信息。这四个极端位置分别是 1 把位 1 弦，1 把位 6 弦，12 把位 1 弦，12 把位 6 弦。
2. 而在上面的四个极端位置上，都存在三个可能的手掌角度，分别对应食指与中指不按同一品时的 NORMAL 状态，食指与中指按同一品时且食指向内的 INNER 状态，食指与中指按同一品且食指向外的 OUTER 状态。
3. 通过判断每一个 time 的手型信息，然后通过在以上这些极端位置和对应手型的数据中进行插值，就可以得到每个关键帧上的一系列控制器的信息，从而生成动画。
4. 右手动画的原理是，在音孔上方附近确定几个右手掌可能停放的位置，以及在六根弦上寻找一些可能的手指触弦位置。每次要演奏的时候把对应的手掌和手指放到这些弹奏位置上即可。

在 blender 文件夹中，有一些在 blender 运行的脚本，就是为了实现以上目的服务的。

### 其它

本项目的目的并不是为了输出给人类看的 tab,因为传统的 tab 只记录了需要按下的左手手指的运动，但对于未按弦的左手手指，缺乏对它们位置的记录。
当然，对于人类来讲，这无伤大雅，因为人类会自然的把不使用的手指移动到他觉得合适的地方。
但如果考虑到动画生成时，需要每个关键帧上的每个手指的位置信息，那么传统的 tab 就不够用了。
所以本项目的目标是输出一个包含每个 beat 的所有手指信息的序列，这样就可以为动画生成提供足够的信息。
